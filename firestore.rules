rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======================
    // Helper Functions
    // ======================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserCompanyId() {
      return getUserData().companyId;
    }
    
    function isCompanyAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().companyRole == 'company_admin';
    }
    
    function isCompanyMember() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().companyRole in ['company_admin', 'company_member'];
    }
    
    function isSameCompany(resourceCompanyId) {
      return isCompanyMember() && getUserCompanyId() == resourceCompanyId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().isAdmin == true;
    }
    
    // ======================
    // Development/Testing Helper Functions
    // ======================
    
    function isAuthenticatedUser() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function hasValidUserDocument() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             getUserData().uid == request.auth.uid;
    }
    
    // ======================
    // Company Management
    // ======================
    
    match /companies/{companyId} {
      // Company admins can manage their own company
      allow read, write: if isCompanyMember() && getUserCompanyId() == companyId;
      
      // System admins can manage all companies
      allow read, write: if isAdmin();
      
      // Allow authenticated users to read companies (for development)
      allow read: if isAuthenticatedUser();
    }
    
    match /company_settings/{settingId} {
      // Company admins can manage their company settings
      allow read, write: if isCompanyMember() && 
        getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all company settings
      allow read, write: if isAdmin();
      
      // Allow authenticated users to read settings (for development)
      allow read: if isAuthenticatedUser();
    }
    
    // ======================
    // Core Collections Rules
    // ======================
    
    // Users Collection - Multi-tenant with company isolation
    match /users/{userId} {
      // Allow authenticated users to read either:
      // - their own profile by UID, or
      // - any profile whose email matches their signed-in Google email, or
      // - an unclaimed pre-seeded record (uid is not yet set/empty) to support first-time claim by ID code
      // - other users in the same company (for company collaboration)
      // - any user if authenticated (for development)
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        resource.data.email == request.auth.token.email ||
        resource.data.uid == null || resource.data.uid == '' ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          getUserCompanyId() == resource.data.companyId
        ) ||
        // Development: Allow any authenticated user to read any user
        isAuthenticatedUser()
      );
      
      // Allow any authenticated user to create their own profile during ID code claim
      // This supports the ID code claim flow where a user creates their profile after Google sign-in
      allow create: if isSignedIn();
      
      // Allow users to update their own profile OR perform a safe one-time claim on a pre-seeded record.
      // Claim cases supported:
      // 1) Both `email` and `uid` are unset: allow setting both to caller's values
      // 2) `email` is already set to caller's email and `uid` is unset: allow setting only `uid`
      // 3) New user creation during ID code claim (document doesn't exist yet)
      allow update: if isSignedIn() && (
        // Caller owns the profile by UID
        request.auth.uid == userId ||
        // Claiming a pre-seeded record
        (
          (resource.data.uid == null || resource.data.uid == '') && (
            // Case 1: set both uid and email when both are unset
            (
              (resource.data.email == null || resource.data.email == '') &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['uid', 'email']) &&
              request.resource.data.uid == request.auth.uid &&
              request.resource.data.email == request.auth.token.email
            ) ||
            // Case 2: set only uid when email already matches caller
            (
              resource.data.email == request.auth.token.email &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['uid']) &&
              request.resource.data.uid == request.auth.uid
            )
          )
        ) ||
        // Development: Allow any authenticated user to update any user
        isAuthenticatedUser()
      );
      
      // Company admins can manage all users in their company
      allow read, write: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all users
      allow read, write: if isAdmin();
    }
    
    // ID Code Verification Collection - Multi-tenant
    match /id_codes/{codeId} {
      // Company admins can manage codes in their company
      allow read, write: if isCompanyMember() && 
        getUserCompanyId() == resource.data.companyId;

      // System admins can manage all codes
      allow read, write: if isAdmin();

      // Allow unauthenticated users to verify a specific code by ID
      allow get: if true;

      // Allow a one-time client-side claim of an unused code
      allow update: if isSignedIn() &&
                    (resource.data.used == false || resource.data.used == null) &&
                    request.resource.data.used == true &&
                    request.resource.data.claimedByUid == request.auth.uid &&
                    request.resource.data.claimedByEmail == request.auth.token.email &&
                    request.resource.data.diff(resource.data).changedKeys().hasOnly(['used', 'claimedByUid', 'claimedByEmail', 'claimedAt']);
      
      // Development: Allow authenticated users to read any code
      allow read: if isAuthenticatedUser();
    }
    
    // Teams Collection - Multi-tenant
    match /teams/{teamId} {
      // Company members can read teams in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can manage teams in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all teams
      allow read, write: if isAdmin();
      
      // Development: Allow authenticated users to read any team
      allow read: if isAuthenticatedUser();
    }
    
    // Projects Collection - Multi-tenant
    match /projects/{projectId} {
      // Company members can read projects in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all projects in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can update projects they are assigned to
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid in resource.data.assignedTo;
      
      // Development: Allow any authenticated user to read and update projects
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid in resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Tasks Collection - Multi-tenant
    match /tasks/{taskId} {
      // Company members can read tasks in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all tasks in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can update tasks assigned to them
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.assignedTo;
      
      // Development: Allow any authenticated user to read and update tasks
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid == resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Content Tasks Collection - Multi-tenant
    match /content_tasks/{taskId} {
      // Company members can read content tasks in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all content tasks in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can update content tasks assigned to them
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.assignedTo;
      
      // Development: Allow any authenticated user to read and update content tasks
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid == resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Notifications Collection - Multi-tenant
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticatedUser() && request.auth.uid == resource.data.userId;
      
      // System can create notifications for users
      allow create: if isAuthenticatedUser();
      
      // Development: Allow any authenticated user to read notifications
      allow read: if isAuthenticatedUser();
    }
    
    // Activity Logs Collection - Multi-tenant
    match /activity_logs/{logId} {
      // Users can read their own activity logs
      allow read: if isAuthenticatedUser() && request.auth.uid == resource.data.userId;
      
      // Users can create their own activity logs
      allow create: if isAuthenticatedUser() && request.auth.uid == request.resource.data.userId;
      
      // Development: Allow any authenticated user to read and create activity logs
      allow read, create: if isAuthenticatedUser();
    }
    
    // Announcements Collection - Multi-tenant
    match /announcements/{announcementId} {
      // Company members can read announcements in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can manage announcements in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all announcements
      allow read, write: if isAdmin();
      
      // Development: Allow any authenticated user to read announcements
      allow read: if isAuthenticatedUser();
      allow create, update, delete: if isAuthenticatedUser();
    }
    
    // Wiki Documents Collection - Multi-tenant
    match /wiki_docs/{docId} {
      // Company members can read wiki docs in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can manage wiki docs in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all wiki docs
      allow read, write: if isAdmin();
      
      // Development: Allow any authenticated user to read wiki docs
      allow read: if isAuthenticatedUser();
    }
    
    // Notifications Collection - Multi-tenant
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isSignedIn() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.userId;
      
      // Company admins can create notifications for users in their company
      allow create: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can update their own notifications (mark as read)
      allow update: if isSignedIn() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.userId;
      
      // Development: Allow any authenticated user to read notifications
      allow read: if isAuthenticatedUser();
      allow create, update: if isAuthenticatedUser();
    }
    
    // Audit Logs Collection - Multi-tenant
    match /audit_logs/{logId} {
      // Company admins can read audit logs in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System can create audit logs
      allow create: if true;
      
      // System admins can read all audit logs
      allow read: if isAdmin();
      
      // Development: Allow any authenticated user to read audit logs
      allow read: if isAuthenticatedUser();
    }
    
    // Analytics Collection - Multi-tenant
    match /analytics/{analyticsId} {
      // Company admins can read analytics in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System can create analytics
      allow create: if true;
      
      // System admins can read all analytics
      allow read: if isAdmin();
      
      // Development: Allow any authenticated user to read analytics
      allow read: if isAuthenticatedUser();
    }
    
    // Subscriptions Collection - Multi-tenant
    match /subscriptions/{subscriptionId} {
      // Company admins can read their company subscription
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can manage all subscriptions
      allow read, write: if isAdmin();
      
      // Development: Allow any authenticated user to read subscriptions
      allow read: if isAuthenticatedUser();
    }
    
    // System Collections (Restricted Access)
    match /system_settings/{settingId} {
      allow read, write: if isAdmin();
    }
    
    // ======================
    // Sales Collections
    // ======================
    
    // Sales Leads Collection - Multi-tenant
    match /sales_leads/{leadId} {
      // Company members can read leads in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all leads in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Sales agents can update leads assigned to them
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.assignedTo;
      
      // Development: Allow any authenticated user to read and update leads
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid == resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Clients Collection - Multi-tenant
    match /clients/{clientId} {
      // Company members can read clients in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all clients in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Sales agents can update clients assigned to them
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.assignedTo;
      
      // Admins can update any client's commission
      allow update: if isAdmin();
      
      // Development: Allow any authenticated user to read and update clients
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid == resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Sales Commissions Collection - Multi-tenant
    match /sales_commissions/{commissionId} {
      // Company members can read commissions in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all commissions in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Sales agents can read their own commissions
      allow read: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.salesAgentId;
      
      // Development: Allow any authenticated user to read commissions
      allow read: if isAuthenticatedUser();
      allow create: if isAuthenticatedUser();
    }
    
    // Content Leads Collection - Multi-tenant
    match /content_leads/{leadId} {
      // Company members can read content leads in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can create and manage all content leads in their company
      allow create, update, delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can update content leads assigned to them
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.auth.uid == resource.data.assignedTo;
      
      // Admins can read all content leads for monitoring
      allow read: if isAdmin();
      
      // Development: Allow any authenticated user to read and update content leads
      allow read: if isAuthenticatedUser();
      allow update: if isAuthenticatedUser() && 
                   request.auth.uid == resource.data.assignedTo;
      allow create: if isAuthenticatedUser();
    }
    
    // Content Ideas Collection - Multi-tenant
    match /content_ideas/{ideaId} {
      // Users can read and manage their own content ideas
      allow read, write: if isAuthenticatedUser() && resource.data.creatorId == request.auth.uid;
      allow create: if isAuthenticatedUser() && request.auth.uid == resource.data.creatorId;
      
      // Company members can read content ideas from their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Admins can read all content ideas for monitoring
      allow read: if isAdmin();
      
      // Development: Allow any authenticated user to read and create content ideas
      allow read: if isAuthenticatedUser();
      allow create: if isAuthenticatedUser();
    }
    
    // Uploaded Files Collection - Multi-tenant
    match /uploaded_files/{fileId} {
      // Users can read and manage their own uploaded files
      allow read, write: if isAuthenticatedUser() && resource.data.uploadedBy == request.auth.uid;
      allow create: if isAuthenticatedUser() && request.data.uploadedBy == request.auth.uid;
      
      // Company members can read uploaded files from their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Company admins can manage all uploaded files in their company
      allow read, write: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Admins can read all uploaded files for monitoring
      allow read: if isAdmin();
      
      // Development: Allow any authenticated user to create and read uploaded files
      allow create: if isAuthenticatedUser();
      allow read: if isAuthenticatedUser();
    }
    
    // ======================
    // Onboarding Flow Support
    // ======================
    
    // Contracts Collection - Multi-tenant
    match /contracts/{contractId} {
      // Company admins can read and manage all contracts in their company
      allow read, write: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // Users can read their own contracts
      allow read: if isSignedIn() && 
                   getUserCompanyId() == resource.data.companyId &&
                   resource.data.uid == request.auth.uid;
      
      // Users can create their own contracts during onboarding
      allow create: if isSignedIn() && 
                   getUserCompanyId() == resource.data.companyId &&
                   request.resource.data.uid == request.auth.uid;
      
      // Users can update their own contracts (e.g., status updates)
      allow update: if isSignedIn() && 
                   getUserCompanyId() == resource.data.companyId &&
                   resource.data.uid == request.auth.uid;
    
      // System admins can manage all contracts
      allow read, write: if isAdmin();
      
      // Development: Allow any authenticated user to read and create contracts
      allow read: if isAuthenticatedUser();
      allow create: if isAuthenticatedUser() && 
                   request.resource.data.uid == request.auth.uid;
      allow update: if isAuthenticatedUser() && 
                   resource.data.uid == request.auth.uid;
    }
    
    match /pending_registrations/{docId} {
      // Anyone can create a pending registration
      allow create: if true;
      
      // Company admins can read pending registrations in their company
      allow read: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can read all pending
      allow read: if isAdmin();
      
      // Users can read their own pending registration
      allow read: if isSignedIn() && resource.data.email == request.auth.token.email;
      
      // Company admins can delete pending registrations in their company
      allow delete: if isCompanyMember() && getUserCompanyId() == resource.data.companyId;
      
      // System admins can delete all pending registrations
      allow delete: if isAdmin();
      
      // Development: Allow any authenticated user to read pending registrations
      allow read: if isAuthenticatedUser();
    }
    
    // ======================
    // Collection Listing Rules
    // ======================
    
    // Allow listing collections for company members
    match /users {
      allow list: if isCompanyMember();
    }
    
    match /teams {
      allow list: if isCompanyMember();
    }
    
    match /projects {
      allow list: if isCompanyMember();
    }
    
    match /tasks {
      allow list: if isCompanyMember();
    }
    
    match /content_tasks {
      allow list: if isCompanyMember();
    }
    
    match /notifications {
      allow list: if isCompanyMember();
    }
    
    match /activity_logs {
      allow list: if isCompanyMember();
    }
    
    match /announcements {
      allow list: if isCompanyMember();
    }
    
    match /wiki_docs {
      allow list: if isCompanyMember();
    }
    
    match /notifications {
      allow list: if isCompanyMember();
    }
    
    match /audit_logs {
      allow list: if isCompanyMember();
    }
    
    match /analytics {
      allow list: if isCompanyMember();
    }
    
    match /contracts {
      allow list: if isCompanyMember();
    }
    
    match /sales_leads {
      allow list: if isCompanyMember();
    }
    
    match /clients {
      allow list: if isCompanyMember();
    }
    
    match /sales_commissions {
      allow list: if isCompanyMember();
    }
    
    // Development: Allow listing collections for any authenticated user
    match /users {
      allow list: if isAuthenticatedUser();
    }
    
    match /teams {
      allow list: if isAuthenticatedUser();
    }
    
    match /projects {
      allow list: if isAuthenticatedUser();
    }
    
    match /tasks {
      allow list: if isAuthenticatedUser();
    }
    
    match /content_tasks {
      allow list: if isAuthenticatedUser();
    }
    
    match /notifications {
      allow list: if isAuthenticatedUser();
    }
    
    match /activity_logs {
      allow list: if isAuthenticatedUser();
    }
    
    match /announcements {
      allow list: if isAuthenticatedUser();
    }
    
    match /wiki_docs {
      allow list: if isAuthenticatedUser();
    }
    
    match /notifications {
      allow list: if isAuthenticatedUser();
    }
    
    match /audit_logs {
      allow list: if isAuthenticatedUser();
    }
    
    match /analytics {
      allow list: if isAuthenticatedUser();
    }
    
    match /contracts {
      allow list: if isAuthenticatedUser();
    }
    
    match /sales_leads {
      allow list: if isAuthenticatedUser();
    }
    
    match /clients {
      allow list: if isAuthenticatedUser();
    }
    
    match /sales_commissions {
      allow list: if isAuthenticatedUser();
    }
    
    match /content_leads {
      allow list: if isAuthenticatedUser();
    }
    
    match /content_ideas {
      allow list: if isAuthenticatedUser();
    }
    
    match /uploaded_files {
      allow list: if isAuthenticatedUser();
    }
    
    // ======================
    // Contracts Collection
    // ======================
    
    // Contract Collection List
    match /contracts {
      allow list: if isAuthenticatedUser();
    }
    
    // Contract Documents
    match /contracts/{contractId} {
      // Anyone can read contracts (for client signing)
      allow read: if true;
      
      // Authenticated users can create contracts
      allow create: if isAuthenticatedUser();
      
      // Users can update their own contracts
      allow update: if isAuthenticatedUser() && 
                   (request.auth.uid == resource.data.assignedTo || 
                    resource.data.contractStatus != 'signed');
      
      // Company admins can update all contracts in their company
      allow update: if isCompanyMember() && 
                   getUserCompanyId() == resource.data.companyId;
      
      // Admins can manage all contracts
      allow write: if isAdmin();
    }
    
    // ======================
    // Default Deny Rule
    // ======================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}